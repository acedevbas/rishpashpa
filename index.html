<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#10192f" />
    <title>Квадратное дыхание</title>
    <link rel="stylesheet" href="styles.css" />
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  </head>
  <body>
    <div id="root"></div>
    <script type="text/babel">
      const STEP_DURATION = 4;
      const STEPS = [
        {
          key: "inhale",
          label: "Вдох",
          description: "Медленно наполняйте лёгкие воздухом.",
          angle: 0,
          scale: 1.06,
        },
        {
          key: "hold-full",
          label: "Задержка",
          description: "Ощутите спокойствие и стабильность.",
          angle: 90,
          scale: 1.12,
        },
        {
          key: "exhale",
          label: "Выдох",
          description: "Отпускайте напряжение и выдыхайте.",
          angle: 180,
          scale: 0.94,
        },
        {
          key: "hold-empty",
          label: "Пауза",
          description: "Сохраняйте лёгкость перед следующим вдохом.",
          angle: 270,
          scale: 1,
        },
      ];

      const formatSeconds = (seconds) => seconds.toString().padStart(2, "0");

      function StepTimeline({ steps, activeIndex, secondsLeft }) {
        return (
          <div className="step-timeline">
            {steps.map((step, index) => {
              const isActive = index === activeIndex;
              const isCompleted = index < activeIndex;
              const progress = isCompleted
                ? 1
                : isActive
                ? (STEP_DURATION - secondsLeft) / STEP_DURATION
                : 0;

              return (
                <div key={step.key} className={`step ${isActive ? "is-active" : ""}`}>
                  <div
                    className="step-indicator"
                    aria-hidden="true"
                    style={{
                      background: isCompleted
                        ? "linear-gradient(135deg, #5fa6ff, #b8c7ff)"
                        : isActive
                        ? "linear-gradient(135deg, #7cc9ff, #4c8dff)"
                        : "rgba(124, 201, 255, 0.16)",
                      boxShadow: isActive
                        ? "0 0 12px rgba(80, 149, 255, 0.5)"
                        : "0 0 0 transparent",
                    }}
                  />
                  <div className="step-content">
                    <div className="step-heading">
                      <span className="step-title">{step.label}</span>
                      <span className="step-duration">4 с</span>
                    </div>
                    <div className="step-bar" role="progressbar" aria-valuemin="0" aria-valuemax="4" aria-valuenow={isActive ? STEP_DURATION - secondsLeft : isCompleted ? STEP_DURATION : 0}>
                      <span style={{ width: `${progress * 100}%` }} />
                    </div>
                  </div>
                </div>
              );
            })}
          </div>
        );
      }

      function ControlPanel({ isRunning, onToggle, onReset, cyclesCompleted }) {
        return (
          <div className="control-panel">
            <button className={`primary-btn ${isRunning ? "is-pause" : ""}`} onClick={onToggle}>
              {isRunning ? "Пауза" : "Старт"}
            </button>
            <button className="ghost-btn" onClick={onReset}>
              Сбросить
            </button>
            <div className="cycles-counter" aria-live="polite">
              Циклов завершено: <span>{cyclesCompleted}</span>
            </div>
          </div>
        );
      }

      function App() {
        const [isRunning, setIsRunning] = React.useState(true);
        const [phaseIndex, setPhaseIndex] = React.useState(0);
        const [secondsLeft, setSecondsLeft] = React.useState(STEP_DURATION);
        const [cyclesCompleted, setCyclesCompleted] = React.useState(0);

        React.useEffect(() => {
          const tg = window.Telegram?.WebApp;
          if (tg) {
            tg.ready();
            tg.expand();
            tg.setBackgroundColor?.("#0c1529");
            tg.setHeaderColor?.("#182240");
          }
        }, []);

        React.useEffect(() => {
          if (!isRunning) {
            return undefined;
          }

          const intervalId = setInterval(() => {
            setSecondsLeft((prev) => {
              if (prev > 1) {
                return prev - 1;
              }

              setPhaseIndex((current) => {
                const nextIndex = (current + 1) % STEPS.length;
                if (nextIndex === 0) {
                  setCyclesCompleted((value) => value + 1);
                }
                return nextIndex;
              });

              return STEP_DURATION;
            });
          }, 1000);

          return () => clearInterval(intervalId);
        }, [isRunning]);

        const activeStep = STEPS[phaseIndex];

        const handleToggle = () => setIsRunning((prev) => !prev);
        const handleReset = () => {
          setIsRunning(false);
          setPhaseIndex(0);
          setSecondsLeft(STEP_DURATION);
          setCyclesCompleted(0);
          setTimeout(() => setIsRunning(true), 300);
        };

        const progressThroughCycle =
          ((phaseIndex * STEP_DURATION + (STEP_DURATION - secondsLeft)) /
            (STEPS.length * STEP_DURATION)) *
          100;

        return (
          <div className="app">
            <header className="app-header">
              <div>
                <h1>Квадратное дыхание</h1>
                <p>
                  Синхронизируйте дыхание с визуализацией: четыре равных шага по четыре секунды
                  помогают быстро восстановить спокойствие.
                </p>
              </div>
              <div className="cycle-progress" aria-hidden="true">
                <span style={{ width: `${progressThroughCycle}%` }} />
              </div>
            </header>

            <div className={`breath-square breath-${activeStep.key}`} style={{ "--rotation": `${activeStep.angle}deg`, "--scale": activeStep.scale }}>
              <div className="breath-inner">
                <div className="phase-label">{activeStep.label}</div>
                <div className="phase-timer">00:{formatSeconds(secondsLeft)}</div>
                <div className="phase-description">{activeStep.description}</div>
              </div>
            </div>

            <StepTimeline steps={STEPS} activeIndex={phaseIndex} secondsLeft={secondsLeft} />

            <ControlPanel
              isRunning={isRunning}
              onToggle={handleToggle}
              onReset={handleReset}
              cyclesCompleted={cyclesCompleted}
            />

            <footer className="app-footer">
              <p>
                Совет: выполняйте минимум четыре цикла и наблюдайте, как постепенно снижается уровень
                стресса.
              </p>
            </footer>
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>
